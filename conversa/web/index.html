<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io();

      // ====== SEND MIC TO SERVER ======
      async function startAudio() {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });

        const audioCtx = new AudioContext({ sampleRate: 16000 });
        const source = audioCtx.createMediaStreamSource(stream);

        // Create ScriptProcessorNode to get raw PCM data
        const processor = audioCtx.createScriptProcessor(4096, 1, 1);

        processor.onaudioprocess = (e) => {
          const inputData = e.inputBuffer.getChannelData(0); // Float32Array [-1, 1]

          // Convert float32 [-1, 1] to int16 PCM
          const pcm16 = new Int16Array(inputData.length);
          for (let i = 0; i < inputData.length; i++) {
            const s = Math.max(-1, Math.min(1, inputData[i]));
            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
          }

          // Send raw PCM bytes to server
          socket.emit("audio_in", pcm16.buffer);
        };

        source.connect(processor);
        processor.connect(audioCtx.destination);
      }
      startAudio();

      // ====== PLAY AUDIO FROM SERVER ======
      const playbackCtx = new AudioContext();

      socket.on("audio_out", async (arrayBuffer) => {
        const audioBuffer = await playbackCtx.decodeAudioData(
          arrayBuffer.slice(0)
        );
        const source = playbackCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(playbackCtx.destination);
        source.start();
      });
    </script>
    <title>Conversa</title>
  </head>
  <body>
    <h1>Hello from the home page!</h1>
  </body>
</html>
